# JoyCar - ovládání motorů

Pro ovládaní motorů je na joycar-u použitý obvod PCA9633. Je to LED driver pro 4 (skupiny) LED. Ale místo LED jsou připojeny motory (dává to napětí pro jednotlivé směry motorů). 
Datasheet je k dispozici [zde](https://media.digikey.com/pdf/Data%20Sheets/NXP%20PDFs/PCA9633.pdf).

Tento budič má možnost vystupovat až na 5 adresách. Čtyři z nich jdou vypnout (přes MODE1) a nastavit jejich adresy (přes SUBADR1, SUBADR2, SUBADR3, ALLCALLADR).
Což znamená, že adresa 0x70 (která je použita v návodech joycar-u) jde vypnout!

Adresa 0x62 (u sterších verzí 0x60) je dána HW zadrátováním čipu PCA9633. 8 pinový čip má adresu 0x62 (nejde ji změnit), 10 pinový může mít adresu 0x60-0x63 (podle toho na jaké napětí připojíme piny A0 a A1). Ještě existuje 16 pinová verze tohoto čipu, u která má všech 7 bitů adresy vyvedeny (A0 až A6) a šlo by tedy připojní vhodných napětí zvolit jakoukoliv i2c adresu.

- První byte, který zapíšeme do i2c na adresu cipu PCA9633 se dostane do control registru (strana 10 dokumentace).
[ControlRegistr](img/PCA9633%20-%201%20Control%20register.png)
Podle hodnoty ve spodním polovině bytu (nibble) se adresuje registr, do kterého chceme následně zapsat. Horní nibble přikazuje jestli a jak se mají měnit adresy pro příští zápis do registru. Ale to nevyužíváme - vždy zapisujeme jen 2 byte (control registr, hodnota pro adresovaný regist z předchozího bytu).

- Seznam adres jednotlivých registrů (strana 11 dokumentace)
[RegisterList](img/PCA9633%20-%202%20Register%20definition.png)

- Při inicializaci používáme následující dvojice bytů: [0xE8, 0xAA] a [0x00, 0x01].

-- První zapisuje do registru 8 (LEDOUT). Hodnota 0xAA říká že všechny 4  výstupy se mají řídit přes registry PWMx (strana 14 dokumentace).
[Register LEDOUT](img/PCA9633%20-%203%20Register%208%20-%20LEDOUT.png)

-- Druhý zapisuje do registru 0 (MODE1) a vypne sleep a vypne 3 i2c subadresy. Probuzení ze sleep-u by mělo trvat 500us (strana 12 dokumentace). Proto hned po inicializaci nefunguje ovládání motorů. Ale měl by tedy s rezervou stačit sleep(2).
[Register MODE1](img/PCA9633%20-%204%20Register%201%20-%20MODE1.png)

- Když zapisujeme na adresu 2 až 5, zapisujeme do registru PWM0 až PWM3 (strana 13 dokumentace).
Hodnoty těchto registrů jdou i přečíst (ne jen zapsat). Ale z hlediska SW v pico:ed-u bude jednodušší si hodnoty pwm (pro pozdější změnu) zapamatovat jako atribut v instanci motoru než vyčítat 2 registry přes I2c.
[Register PWMx](img/PCA9633%20-%205%20Register%202-5%20-%20PWMx.png)
