# JoyCar - ovládání motorů

Pro ovládaní motorů je na joycar-u použitý obvod **PCA9633**. Je to LED driver pro 4 (skupiny) LED. Ale místo LED jsou připojeny motory (dává to napětí pro jednotlivé směry motorů). 
**Datasheet je k dispozici [zde](datasheet/PCA9633.pdf).**

## Adresování PCA9633
Tento driver (budič) má možnost na i2c vystupovat až na pěti adresách.
### HW a SW adresy
- **HW adresa:** 0x62 (na starší verzi joycar-u: 0x60).  
  8 pinový čip PCA9633 má adresu 0x62 (nejde ji změnit), 10 pinový může mít adresu 0x60 až 0x63 (podle toho na jaké napětí připojíme piny A0 a A1). Ještě existuje 16 pinová verze tohoto čipu, u která má všech 7 bitů adresy vyvedeny (A0 až A6) a šlo by tedy připojní vhodných napětí zvolit jakoukoliv i2c adresu.  
- **SW adresy:** Až čtyři adresy nastavitelné pomocí registrů **SUBADR1**, **SUBADR2**, **SUBADR3**, **ALLCALLADR**.
Všechny 4 SW adresy jsou vypínatelné, včetně adresy **0x70**! (Viz registr **MODE1**).  
  Poznámka: *Adresy a popis jednotlivých registrů budiče je uvedený níže*.

### Struktura registrů
- **Control registr**  
První byte, který zapíšeme do i2c na adresu budiče PCA9633 se dostane do **control registru** (strana 10 dokumentace). Podle hodnoty ve spodním polovině bytu (nibble) se adresuje registr, do kterého chceme následně zapsat/nebo z něj číst (seznam adres registrů je uveden na straně 11 dokumentace). Horní nibble přikazuje jestli a jak se mají měnit adresy pro příští zápis do registru. Tuto možnost ale nevyužíváme - vždy zapisujeme jen 2 byte (control registr, hodnota pro další registr).  
![ControlRegistr](img/PCA9633%20-%201%20Control%20register.png)
![RegisterList](img/PCA9633%20-%202%20Register%20definition.png)

- **MODE1 registr**  
  Při inicializaci motorů jsou v návodech joycar-u použíté následující dvojice bytů: [0x00, 0x01] a [0xE8, 0xAA].  
  První dvojice bytů [0x00, 0x01] způsobí zápis do registru 0 (**MODE1**). Vypne sleep a vypne 3 i2c subadresy (**SUBADR1**, **SUBADR2**, **SUBADR3**) ale **ALLCALLADR** zůstane zapnutá. Probuzení ze sleep-u by mělo trvat 500us (strana 12 dokumentace). Proto hned po inicializaci nefunguje ovládání motorů. Ale měl by tedy s rezervou stačit sleep(2).  
![Register MODE1](img/PCA9633%20-%204%20Register%201%20-%20MODE1.png)
  
- **LEDOUT registr**  
  Druhá dvojice bytů [0xE8, 0xAA] způsobí zápis do registru 8 (**LEDOUT**). Hodnota 0xAA říká, že všechny 4 výstupy se mají řídit přes registry PWMx (strana 14 dokumentace).  
![Register LEDOUT](img/PCA9633%20-%203%20Register%208%20-%20LEDOUT.png)

- **PWMx registry**  
  Když zapisujeme na adresu 2 až 5, zapisujeme do registrů **PWM0** až **PWM3** (strana 13 dokumentace). Hodnoty těchto registrů jdou i přečíst (ne jen zapsat). Ale z hlediska SW v micro:bit-u/pico:ed-u bude jednodušší, si hodnoty pwm zapamatovat jako atribut v instanci motoru než vyčítat 2 registry přes I2c.  
![Register PWMx](img/PCA9633%20-%205%20Register%202-5%20-%20PWMx.png)

Pokud začneme používat adresu 0x62, tak můžeme v inicializaci použít tyto zápisy:
```
i2c.write(0x62, bytes([0, 0x00]))
i2c.write(0x62, bytes([8, 0xAA]))
```
